name: MEPHI CI/CD for Python application  # Название рабочего процесса CI/CD для Python-приложения

# Секция триггеров - определяет, когда workflow будет запускаться
on:
  push:  # Автоматически запускает workflow при пуше в указанные ветки
    branches:  # Список веток, на которые распространяется триггер
    - main  # Только основная ветка

  pull_request:  # Автоматически запускает workflow при создании PR в указанные ветки
    branches:
    - main  # Только для PR в основную ветку

permissions:  # Настройка прав доступа для workflow
  contents: read  # Разрешает только чтение содержимого репозитория

# для запуска всех тестов параллельно
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

# Основная секция с заданиями (jobs)
jobs:
  build:  # Задание для сборки и проверки кода
    runs-on: ubuntu-24.04  # Указывает окружение для выполнения задания
    
    steps:  # Последовательность шагов
    - uses: actions/checkout@v4  # Клонирование репозитория
    
    - name: Set up Python 3.10  # Настройка окружения Python
      uses: actions/setup-python@v3  # Использование официального action для Python
      with:
        python-version: "3.10"  # Версия Python для установки
        
    - name: Install dependencies  # Установка зависимостей
      run: |  # Скрипт установки
        python -m pip install --upgrade pip  # Обновление pip
        pip install flake8 pytest  # Установка инструментов проверки
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi  # Установка зависимостей из файла
        
    - name: Lint with flake8  # Проверка стиля кода
      run: |  # Скрипт проверки
        # Проверка синтаксических ошибок и неопределенных имен
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # Дополнительная проверка сложности и длины строк
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

  test-ubuntu:  # Задание для тестирования
    needs: build  # Зависит от успешного завершения задания build
    runs-on: ubuntu-24.04  # Окружение выполнения
    
    steps:  # Шаги тестирования
    - uses: actions/checkout@v4  # Клонирование репозитория

    - name: Set up Python 3.10  # Настройка окружения
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
        
    - name: Running unittests  # Запуск тестов
      run: |
        python -m pip install --upgrade pip  # Обновление pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi  # Установка зависимостей из файла
        python -m unittest discover # запуск тестов

  # Задание для тестирования на Windows
  test-windows:
    needs: build  # Зависит от успешного завершения build
    runs-on: windows-latest  # Используем последнюю версию Windows
    steps:
      - uses: actions/checkout@v4  # Клонирование репозитория
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Running unittests
        run: |
          python -m unittest discover

  # Задание для тестирования на MacOS (Intel)
  test-macos-intel:
    needs: build
    runs-on: macos-latest  # Используем последнюю версию MacOS
    strategy:
      matrix:
        architecture: [x86]  # Указываем архитектуру Intel
    steps:
      - uses: actions/checkout@v4  # Клонирование репозитория
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Running unittests
        run: |
          python -m unittest discover

  # Задание для тестирования на MacOS (Apple Silicon)
  test-macos-applesilicon:
    needs: build
    runs-on: macos-latest  # Используем последнюю версию MacOS
    strategy:
      matrix:
        architecture: [arm64]  # Указываем архитектуру Apple Silicon
    steps:
      - uses: actions/checkout@v4  # Клонирование репозитория
      - name: Set up Python 3.10
        uses: actions/setup-python@v3
        with:
          python-version: "3.10"
      - name: Running unittests
        run: |
          python -m unittest discover

  deploy:  # Задание для деплоя
    needs:  # Зависит от успешного завершения тестов
    - test-ubuntu
    - test-windows
    - test-macos-intel
    - test-macos-applesilicon

    runs-on: ubuntu-24.04  # Окружение выполнения
    
    steps:  # Шаги деплоя
    - name: Checkout code  # Клонирование кода
      uses: actions/checkout@v3
      
    - name: Deploy to server  # Деплой на сервер
      uses: appleboy/ssh-action@v0.1.6  # Использование SSH action
      with:
        host: ${{ secrets.SERVER_HOST }}  # Хост сервера из секретов
        username: ${{ secrets.SERVER_USER }}  # Пользователь из секретов
        key: ${{ secrets.SERVER_KEY }}  # SSH-ключ из секретов
        script: |  # Скрипт деплоя
          cd /app  # Переход в директорию приложения
          git pull origin main  # Обновление кода
          
          # Очистка старых контейнеров
          sudo docker stop $(sudo docker ps -a -q) || true
          sudo docker rm $(sudo docker ps -a -q) || true
          
          # Сборка нового образа
          sudo docker build -t app .
          
          # Запуск контейнера
          sudo docker run -d \
            -p 80:8080 \
            app

          # Очистка остановленных контейнеров
          sudo docker container prune -f
          
          # Удаление неиспользуемых образов старше 24 часов
          sudo docker image prune --filter "until=24h" -f
          
          # Удаление висящих образов
          sudo docker image prune -f
